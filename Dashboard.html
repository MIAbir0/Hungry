<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Hungry</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="CSS/Style.css">
</head>
<body>

    <header>
        <a href="index.html" class="logo"><i class="fas fa-utensils"></i> Hungry </a>

        <nav class="navbar">
            <a href="index.html#home">Home</a>
            <a href="index.html#dishes">Popular Dishes</a>
            <a href="Cuisine.html">Cuisine</a>
            <a href="index.html#about">About</a>
            <a href="Order.html">Order</a>
            <a href="Dashboard.html" class="active">Account</a>
        </nav>

        <div class="icons">
            <i class="fas fa-bars" id="menu-bars"></i>
            <i class="fas fa-search" id="search-icon"></i>
            <a href="#" class="fas fa-shopping-cart" id="cart-toggle"><span id="cart-count">0</span></a>
        </div>
    </header>

    <form action="" id="search-form">
        <input type="search" id="search-box" placeholder="Search for dishes (e.g., pasta, fish)..." autocomplete="off">
        <label for="search-box" class="fas fa-search"></label>
        <div id="search-results" class="search-results" aria-live="polite"></div>
        <i class="fas fa-times" id="close" aria-label="Close search"></i>
    </form>

    <main class="dashboard-page">
        <section class="dashboard-card">
            <div class="dashboard-header">
                <div class="avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div style="flex: 1;">
                    <h2 id="dashboardUserName">Loading...</h2>
                    <p id="dashboardUserEmail">—</p>
                </div>
                <button id="editProfileBtn" class="btn-icon" title="Edit Profile">
                    <i class="fas fa-edit"></i>
                </button>
            </div>

            <div class="dashboard-info" id="dashboardInfoView">
                <div class="info-item">
                    <i class="fas fa-user"></i>
                    <div>
                        <span class="label">Full Name</span>
                        <span id="dashboardUserFullName">—</span>
                    </div>
                </div>
                <div class="info-item">
                    <i class="fas fa-phone"></i>
                    <div>
                        <span class="label">Phone</span>
                        <span id="dashboardUserPhone">—</span>
                    </div>
                </div>
                <div class="info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <div>
                        <span class="label">Address</span>
                        <span id="dashboardUserAddress">—</span>
                    </div>
                </div>
                <div class="info-item">
                    <i class="fas fa-city"></i>
                    <div>
                        <span class="label">City</span>
                        <span id="dashboardUserCity">—</span>
                    </div>
                </div>
            </div>

            <form id="dashboardEditForm" class="dashboard-edit-form" style="display: none;">
                <div class="form-group">
                    <label>
                        <i class="fas fa-user"></i> Full Name
                        <input type="text" id="editFullName" name="fullName" required>
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <i class="fas fa-phone"></i> Phone Number
                        <div class="phone-input">
                            <span class="country-code">+880</span>
                            <input type="tel" id="editPhone" name="phone" pattern="[0-9]{10,11}" required>
                        </div>
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <i class="fas fa-map-marker-alt"></i> Address
                        <input type="text" id="editAddress" name="address">
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <i class="fas fa-city"></i> City
                        <input type="text" id="editCity" name="city">
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <i class="fas fa-mail-bulk"></i> Postal Code
                        <input type="text" id="editPostal" name="postal">
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancelEditBtn" class="btn">Cancel</button>
                    <button type="submit" class="btn primary">Save Changes</button>
                </div>
            </form>

            <div class="dashboard-actions">
                <a href="Order.html" class="btn primary"><i class="fas fa-shopping-bag"></i> Place Order</a>
                <a href="index.html#dishes" class="btn"><i class="fas fa-utensils"></i> Browse Menu</a>
            </div>

            <div class="dashboard-orders">
                <h3><i class="fas fa-history"></i> Order History</h3>
                <div id="dashboardOrderList" class="order-list">
                    <p class="loading">Loading orders...</p>
                </div>
                <p id="dashboardOrderEmpty" class="order-empty" style="display: none;">No orders yet. Place your first order!</p>
            </div>

            <button id="dashboardLogoutBtn" class="btn logout-btn"><i class="fas fa-sign-out-alt"></i> Log Out</button>
        </section>
    </main>

    <aside id="cart-panel" aria-hidden="true">
        <div class="cart-header">
            <h2>Your Cart</h2>
            <button id="cart-close" aria-label="Close Cart">&times;</button>
        </div>
        <div id="cart-items"></div>
        <div class="cart-footer">
            <div class="cart-total">Total: <span id="cart-total">0</span> TK</div>
            <button id="cart-clear" class="btn">Clear Cart</button>
            <button id="cart-order" class="btn primary">Order Now</button>
        </div>
    </aside>

    <script src="script.js"></script>
    <script>
        (async function() {
            const API_BASE = window.__HUNGRY_API_BASE__ || "http://localhost:5000";
            
            async function apiFetch(path, opts = {}) {
                const res = await fetch(API_BASE + path, {
                    credentials: "include",
                    headers: { "Content-Type": "application/json" },
                    ...opts
                });
                const body = await res.json().catch(() => ({}));
                return { ok: res.ok, body };
            }

            // Check if logged in
            const { ok, body } = await apiFetch("/api/auth/profile");
            
            if (!ok || !body.success || !body.user) {
                // Not logged in, redirect to Auth page
                window.location.href = "Auth.html";
                return;
            }

            // Populate dashboard
            let currentUser = body.user;
            
            function updateDashboardDisplay(user) {
                document.getElementById("dashboardUserName").textContent = user.fullName || "User";
                document.getElementById("dashboardUserEmail").textContent = user.email || "—";
                document.getElementById("dashboardUserFullName").textContent = user.fullName || "—";
                document.getElementById("dashboardUserPhone").textContent = user.phone || "—";
                document.getElementById("dashboardUserAddress").textContent = user.address || "—";
                document.getElementById("dashboardUserCity").textContent = user.city || "—";
            }
            
            updateDashboardDisplay(currentUser);
            
            // Edit functionality
            const editBtn = document.getElementById("editProfileBtn");
            const cancelBtn = document.getElementById("cancelEditBtn");
            const editForm = document.getElementById("dashboardEditForm");
            const infoView = document.getElementById("dashboardInfoView");
            
            editBtn.addEventListener("click", () => {
                // Populate edit form
                document.getElementById("editFullName").value = currentUser.fullName || "";
                document.getElementById("editPhone").value = (currentUser.phone || "").replace(/^\+?880/, "");
                document.getElementById("editAddress").value = currentUser.address || "";
                document.getElementById("editCity").value = currentUser.city || "";
                document.getElementById("editPostal").value = currentUser.postal || "";
                
                // Show form, hide view
                infoView.style.display = "none";
                editForm.style.display = "block";
            });
            
            cancelBtn.addEventListener("click", () => {
                editForm.style.display = "none";
                infoView.style.display = "block";
            });
            
            editForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                
                const formData = {
                    fullName: document.getElementById("editFullName").value,
                    phone: document.getElementById("editPhone").value,
                    address: document.getElementById("editAddress").value,
                    city: document.getElementById("editCity").value,
                    postal: document.getElementById("editPostal").value
                };
                
                try {
                    const { ok, body } = await apiFetch("/api/auth/profile", {
                        method: "PUT",
                        body: JSON.stringify(formData)
                    });
                    
                    if (ok && body.success) {
                        currentUser = body.user;
                        updateDashboardDisplay(currentUser);
                        editForm.style.display = "none";
                        infoView.style.display = "block";
                        alert("Profile updated successfully!");
                    } else {
                        alert(body.message || "Failed to update profile.");
                    }
                } catch (err) {
                    console.error("Update error:", err);
                    alert("Failed to update profile. Please try again.");
                }
            });

            // Load order history
            async function loadOrders() {
                const orderList = document.getElementById("dashboardOrderList");
                const orderEmpty = document.getElementById("dashboardOrderEmpty");
                
                try {
                    const { ok, body } = await apiFetch("/api/orders/my");
                    if (ok && body.success && Array.isArray(body.orders) && body.orders.length) {
                        orderList.innerHTML = body.orders.slice(0, 5).map(order => {
                            const date = new Date(order.date || order.createdAt || Date.now());
                            const formatted = date.toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            const items = Array.isArray(order.items) 
                                ? order.items.map(item => {
                                    if (typeof item === 'object' && item.name) {
                                        return `${item.quantity || 1}× ${item.name}`;
                                    }
                                    if (typeof item === 'string') {
                                        return item;
                                    }
                                    return 'Unknown item';
                                }).join(", ")
                                : "N/A";
                            return `
                                <div class="order-item">
                                    <div class="order-item__header">
                                        <span class="order-id">#${String(order._id || order.id).slice(-6)}</span>
                                        <span class="order-date">${formatted}</span>
                                    </div>
                                    <div class="order-item__body">
                                        <p class="order-items">${items}</p>
                                        <span class="order-total">${order.total || 0} TK</span>
                                    </div>
                                    <span class="order-status ${order.status || 'pending'}">${(order.status || 'pending').toUpperCase()}</span>
                                </div>
                            `;
                        }).join('');
                        orderEmpty.style.display = 'none';
                    } else {
                        orderList.innerHTML = '';
                        orderEmpty.style.display = 'block';
                    }
                } catch (err) {
                    console.error("Error loading orders:", err);
                    orderList.innerHTML = '';
                    orderEmpty.textContent = 'Could not load orders.';
                    orderEmpty.style.display = 'block';
                }
            }
            
            loadOrders();

            // Logout
            document.getElementById("dashboardLogoutBtn").addEventListener("click", async () => {
                await apiFetch("/api/auth/logout", { method: "GET" });
                window.location.href = "Auth.html";
            });
        })();
    </script>
</body>
</html>

